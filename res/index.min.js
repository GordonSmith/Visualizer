define(["exports","@hpcc-js/common","@hpcc-js/composite","@hpcc-js/form","@hpcc-js/map","@hpcc-js/other","@hpcc-js/chart","@hpcc-js/comms","@hpcc-js/dgrid","@hpcc-js/layout","@hpcc-js/graph"],function(t,e,r,i,o,n,s,a,l,u,p){"use strict";var c=function(t,e){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function h(t,e){function r(){this.constructor=t}c(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var d=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return h(e,t),e}(u.Grid);d.prototype._class+=" visualizer_VisualizerGrid",d.prototype.publish("maxRowCount",1e4,"number");var f=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._filter={},e._table=new l.Table,e}return h(e,t),e.prototype.update=function(e,r){t.prototype.update.call(this,e,r)},e.prototype.render=function(e){var r=this;if(0===this._renderCount){var i=this.data().length;this.data().forEach(function(t,e){var i=t[0],o=(new s.Column).columns(["Field ID","Row Count"]).data(t[2].map(function(t){return[t.value,t.rowcount]})).on("click",function(t,e,o){o?r._filter[i]=t["Field ID"]:delete r._filter[i],r.refreshFilter()});r.setContent(0,e,o,t[0]+" ("+t[1]+")")}),this.setContent(i?1:0,0,this._table,"",2,i),this.refreshFilter()}return t.prototype.render.apply(this,arguments)},e.prototype.refreshFilter=function(){var t=this;a.Result.attach({baseUrl:this.baseUrl()},this.logicalFile(),void 0).fetchRows(0,this.maxRowCount(),!1,this._filter).then(function(e){var r=[],i={},o=e.map(function(t,e){var o=[];return 0===e&&Object.keys(t).forEach(function(t,e){r.push(t),i[t]=e}),Object.keys(t).forEach(function(e){o[i[e]]=t[e]}),o});t._table.columns(r).data(o).render()})},e.prototype.click=function(t,e,r){},e}(d);f.prototype._class+=" visualizer_Dashboard",f.prototype.publish("baseUrl",null,"string"),f.prototype.publish("logicalFile",null,"string");var g=function(t){function e(e){var r=t.call(this)||this;return r._id="",r._columns=[],r._data=[],r._metaResult=e,r._id=r._metaResult.name(),r._columns=[],r._data=[],r}return h(e,t),e.prototype.mapData=function(t){var e=this.mappings();return e.length?t.map(function(t){for(var r={},i=0,o=e;i<o.length;i++){var n=o[i];r[n.key]=t[n.value.toLowerCase()]}return r}):t},e.prototype.refreshData=function(t,e){var r=this;void 0===t&&(t={}),void 0===e&&(e=-1);var i,o={},s=!1,a=0;(this.filteredBy().forEach(function(e){var r=t[e.source+"__hpcc_visualization"];r&&(++a,e.mappings.forEach(function(t){o[t.value.toLowerCase()]=r.row[t.key]||r.row[t.key.toLowerCase()]})),s=!0},this),!s||a>0)?i=n.createResult(this._metaResult.url(),this.dataSource(),this.resultName()).query({Start:0,Count:e},o).then(function(t){return n.flattenResult(t,r.mappings())}):i=Promise.resolve({columns:[],data:[]});return i},e}(e.PropertyExt);g.prototype._class+=" WUWudget",g.prototype.publish("widgetClassID",null,"string","ESP Url"),g.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),g.prototype.publish("dataSource",null,"string","Data Source"),g.prototype.publish("resultName",null,"string","Result Name"),g.prototype.publish("mappings",null,"object","Widget Mappings"),g.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),g.prototype.publish("properties",null,"object","Widget Properties");var y=function(t){function e(e){var r=t.call(this)||this;return r._id="",r._columns=[],r._data=[],r._metaResult=e,r._id=r._metaResult.name(),r._columns=[],r._data=[],r}return h(e,t),e.prototype.createWidget=function(){var t=(new(this.widgetClass())).id(this.id());return this.properties().forEach(function(e){"function"==typeof t[e.key]&&t[e.key](e.value)}),t},e.prototype.parseClassID=function(t){var e=t.split("_");return{pkg:"@hpcc-js/"+e[0],def:e[1]}},e.prototype.requireWidget=function(t){var e=this;return new Promise(function(r,i){var o=e.parseClassID(t);if("@hpcc-js/visualizer"===o.pkg)switch(o.def){case"Dashboard":r(f)}else require([o.pkg],function(t){r(t[o.def])})})},e.prototype.resolveWidget=function(){var t=this;return this.requireWidget(t.widgetClassID()).then(function(e){t.widgetClass(e)})},e.prototype.resolve=function(){var t=this;return this._metaResult.query().then(function(e){return e&&e.length?e[0].vertices?t.widgetClassID(e[0].classid).verticesMeta(new g(t._metaResult).widgetClassID(e[0].vertices[0].classid).dataSource(e[0].vertices[0].datasource||t._metaResult.wuid()).resultName(e[0].vertices[0].resultname).mappings(e[0].vertices[0].mappings).filteredBy(e[0].vertices[0].filteredby).properties(e[0].vertices[0].properties)).edgesMeta(new g(t._metaResult).widgetClassID(e[0].edges[0].classid).dataSource(e[0].edges[0].datasource||t._metaResult.wuid()).resultName(e[0].edges[0].resultname).mappings(e[0].edges[0].mappings).filteredBy(e[0].edges[0].filteredby).properties(e[0].edges[0].properties)).filteredBy(e[0].filteredby).properties(e[0].properties):(e[0].properties.push({key:"baseUrl",value:t._metaResult._protocol+"//"+t._metaResult._host+"/"}),t.widgetClassID(e[0].classid).widgetMeta(new g(t._metaResult).widgetClassID(e[0].classid).dataSource(e[0].datasource||t._metaResult.wuid()).resultName(e[0].resultname).mappings(e[0].mappings).filteredBy(e[0].filteredby).properties(e[0].properties)).filteredBy(e[0].filteredby).properties(e[0].properties)):console.log("Visualizer meta-data is empty."),t.resolveWidget().then(function(){return t})})},e.prototype.refreshData=function(t,e){var r=this;void 0===t&&(t={}),void 0===e&&(e=-1);var i=this.widget();return i instanceof p.Graph?Promise.all([this.verticesMeta().refreshData(t,e),this.edgesMeta().refreshData({},-1)]).then(function(t){return r.refreshGraph(i,t[0].data,r.verticesMeta().properties(),t[1].data,r.edgesMeta().properties())}):this.widgetMeta().refreshData(t,e).then(function(t){return r.refreshWidget(i,t)})},e.prototype.refreshWidget=function(t,e){t.columns(e.columns).data(e.data).lazyRender()},e.prototype.refreshGraph=function(t,e,r,i,o){var n={},s=e.map(function(t){var e=(new p.Vertex).text(t[1]);return t[2]?e.faChar(t[2]):e.icon_diameter(0),r.forEach(function(t){"function"==typeof e[t.key]&&e[t.key](t.value)}),n[t[0]]=e,e}),a=i.map(function(t){var e=n[t[0]],r=n[t[1]];if(e&&r){var i=(new p.Edge).sourceVertex(e).targetVertex(r).text(t[2]);return t[2]&&i.text(t[2]),o.forEach(function(t){"function"==typeof i[t.key]&&i[t.key](t.value)}),i}e?console.log("Invalid edge - no target vertex."):r?console.log("Invalid edge - no source vertex."):console.log("Invalid edge - no source or target verticies.")}).filter(function(t){return!!t});t.data({vertices:s,edges:a}).lazyRender()},e}(e.Widget);y.prototype._class+=" WUWudget",y.prototype.publish("widgetClassID",null,"string"),y.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),y.prototype.publish("widget",null,"object","Widget Instance"),y.prototype.publish("widgetMeta",null,"object"),y.prototype.publish("verticesMeta",null,"object"),y.prototype.publish("edgesMeta",null,"object"),y.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),y.prototype.publish("properties",null,"object","Widget Properties"),o.topoJsonFolder("https://unpkg.com/@hpcc-js/map@2.0.0/TopoJSON"),n.enableCache(!0);var v=function(){function t(t){this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={},this._espUrl=t,this._espWorkunit=n.createConnection(this._espUrl),this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={}}return t.prototype.resetPersist=function(){return this._espWorkunit.appData("HPCC-Visualizer","persist"," ")},t.prototype.submitPersist=function(){if(this.grid){var t=n.Persist.serialize(this.grid);this._espWorkunit.appData("HPCC-Visualizer","persist",t)}},t.prototype.fetchPersist=function(){return this._espWorkunit.appData("HPCC-Visualizer","persist").then(function(t){if(t){var e=JSON.parse(t);switch(e.__class){case"visualizer_Dashboard":return r.Persist.deserializeFromObject(new f,e);case"visualizer_VisualizerGrid":return r.Persist.deserializeFromObject(new d,e);default:return r.Persist.create(t)}}return Promise.resolve(null)}).catch(function(t){return Promise.resolve(null)})},t.prototype.fetchWUWidgets=function(){return this._espWorkunit.results().then(function(t){var r=[];return t.filter(function(t){return e.Utility.endsWith(t.name(),"__hpcc_visualization")}).forEach(function(t){var e=new y(t);r.push(e.resolve())}),Promise.all(r)})},t.prototype.createGrid=function(){var t=this;return Promise.all([this.fetchPersist(),this.fetchWUWidgets()]).then(function(e){t.grid=e[0],t._wuWidgets=[],t._wuWidgetMap={};var r=e[1];if(!t.grid){if(1===r.length&&r[0].widgetClass()===f)return t.grid=r[0].createWidget(),r[0].widget(t.grid),r[0].refreshData({},t.grid.maxRowCount()).then(function(){return t.grid});t.grid=new d}var i=Math.ceil(Math.sqrt(r.length)),o=Math.ceil(r.length/i),n=3*(i+1),s=3*(o+1);return t.grid.snappingColumns(n).snappingRows(s),r.forEach(function(e,r){var o=t.grid.getContent(e.id());if(!o){var n=0,s=0;for(o=e.createWidget();null!==t.grid.getCell(3*n,3*s);)++s>=i&&(s=0,++n);t.grid.setContent(3*n,3*s,o,null,3,3)}switch(o.classID()){case"graph_Graph":o.on("vertex_click",function(e,r,i){t.refreshFilters(this.id(),e,r,i)});break;default:o.on("click",function(e,r,i){t.refreshFilters(this.id(),e,r,i)})}o._wuMeta=e,e.widget(o),t._wuWidgets.push(e),t._wuWidgetMap[e.id()]=e}),t.grid})},t.prototype.refresh=function(){var t=this;this._wuWidgets.forEach(function(e){e.refreshData(t._wuDashSel,t.grid.maxRowCount())})},t.prototype.refreshFilters=function(t,e,r,i){var o=this;i?this._wuDashSel[t]={row:e,col:r}:delete this._wuDashSel[t],this._wuWidgets.forEach(function(e){e.filteredBy().forEach(function(r){t===r.source+"__hpcc_visualization"&&e.refreshData(o._wuDashSel,o.grid.maxRowCount())})})},t}(),m=function(t){function e(){return t.call(this)||this}return h(e,t),e.prototype.toggleProperties=function(){var t=r.Dermatology.prototype.toggleProperties.apply(this,arguments);return this._showProperties||this.wuDashboard.submitPersist(),t},e.prototype.reset=function(){var t=this;this.wuDashboard.resetPersist().then(function(e){n.cache({}),delete t._prevEspUrl,t.render(function(t){})})},e.prototype.enter=function(){r.Dermatology.prototype.enter.apply(this,arguments);var t=this;this._resetButton=(new i.Button).id(this.id()+"_reset").value("Reset").on("click",function(){t.reset()}),this._toolbar.widgets([this._resetButton,this._propsButton])},e.prototype.update=function(){if(r.Dermatology.prototype.update.apply(this,arguments),this._prevEspUrl!==this.espUrl()){this._prevEspUrl=this.espUrl(),this.espCache()&&n.cache(JSON.parse(this.espCache()));var t=this;this.wuDashboard=new v(this.espUrl()),this.wuDashboard.createGrid().then(function(e){t.widget(e).render(function(e){t.wuDashboard.refresh()})})}},e}(r.Dermatology);m.prototype._class+=" VizWU",m.prototype.publish("espUrl",null,"string","ESP Url"),m.prototype.publish("espCache",null,"string","ESP Cache");var _=function(t,e){return e[1]<-90?t[0]++:e[1]>90&&t[1]++,t},w=function(t){return t>90?t-360:t},b=function(t){return t<-90?t+360:t},C=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return h(r,t),r.prototype.fixDateLine=function(t,e){var r,i,o=e.reduce(_,[0,0]),n=o[0],s=o[1];return n&&s?e.map((r=t[1]<0,i=r?w:b,function(t){return[t[0],i(t[1])]})):e},r.prototype.hasBounds=function(){return!0},r.prototype.h3Resolution=function(){return Math.floor(15*this.zoom()/this.maxZoom())},r.prototype.updateHexagons=function(){var t=this;this._palette=this._palette.switch(this.paletteID()),this.useClonedPalette()&&(this._palette=this._palette.cloneNotExists(this.paletteID()+"_"+this.id()));var r=this.columns(),i=r.indexOf(this.latitudeColumn()),n=r.indexOf(this.longtitudeColumn()),s=this.h3Resolution();s>15&&(s=15);var a=this.data().filter(function(e){return!t.omitNullLatLong()||!!e[i]&&!!e[n]}),l=e.extent(a,function(t){return 1});this.clear(),a.forEach(function(e){t.add(new o.leaflet.Polygon(t.fixDateLine(e.center,e.boundary),{color:t._palette(l[1]),fillColor:t._palette(1,l[0],l[1]),fillOpacity:t.opacity(),origRow:e}).on("click",function(r){return t.clickHandler(r,e)}))})},r.prototype.layerUpdate=function(e){t.prototype.layerUpdate.call(this,e),this.updateHexagons()},r.prototype.zoomEnd=function(e){t.prototype.zoomEnd.call(this,e)},r.prototype.moveEnd=function(e){t.prototype.moveEnd.call(this,e),this.updateHexagons()},r.prototype.clickHandler=function(t,e){},r}(o.Leaflet.ClusterLayer);function D(t){return t<-90?-90:t>90?90:t}function P(t){return t<-180?-180:t>180?180:t}C.prototype._class+=" map_Hexagons",C.prototype._palette=e.Palette.rainbow("default"),C.prototype.publish("paletteID","YlOrRd","set","Color palette for this widget",C.prototype._palette.switch(),{tags:["Basic","Shared"]}),C.prototype.publish("useClonedPalette",!1,"boolean","Enable or disable using a cloned palette",null,{tags:["Intermediate","Shared"]}),C.prototype.publish("latitudeColumn",null,"set","Latitude column",function(){return this.columns()},{optional:!0}),C.prototype.publish("longtitudeColumn",null,"set","Longtitude column",function(){return this.columns()},{optional:!0}),C.prototype.publish("omitNullLatLong",!0,"boolean","Remove lat=0,lng=0 from pinsData",null,{tags:["Basic"]}),C.prototype.publish("opacity",.5,"number","Opacity",null,{tags:["Advanced"]});var R=function(){function t(t,e){void 0===e&&(e=10),this.childThreshold=e,this.query2=a.Query.attach({baseUrl:"http://localhost:8002"},"roxie","cities2");var r=t.split("/WsEcl/res/query/"),i=r[0],o=r[1].split("/"),n=o[0],s=o[1];this.query=a.Query.attach({baseUrl:i},n,s)}return t.prototype.serverPolyfill=function(t,e){var r={h3PolySetRes:e,childThreshold:this.childThreshold,h3PolySet:{Row:t.map(function(t){return{lat:t[0],lon:t[1]}})}};return this.query.submit(r).then(function(t){return t.IndexCountSet})},t.prototype.submit=function(t,e){var r,i,o=[],n=[];return t.forEach(function(t){(!r||r>t[1])&&(r=t[1]),(!i||i<t[1])&&(i=t[1]),o.push([t[0],t[1]>0?0:t[1]]),n.push([t[0],t[1]<0?0:t[1]])}),i-r>180?Promise.all([this.serverPolyfill(o,e),this.serverPolyfill(n,e)]).then(function(t){var e=t[0],r=t[1];return e.concat(r)}):this.serverPolyfill(t,e)},t.prototype.submit2=function(t,e,r){return this.query2.submit({z:t,x:e,y:r,childThreshold:this.childThreshold}).then(function(t){return t.IndexCountSet})},t}(),W=function(t){function e(e){var r=t.call(this,!1)||this;return r.service=new R(e),r}return h(e,t),e.prototype.createIcon=function(t){var e=" marker-cluster-";return e+=t<10?"small":t<100?"medium":"large",new o.leaflet.DivIcon({html:"<div><span>"+t+"</span></div>",className:"marker-cluster"+e,iconSize:new o.leaflet.Point(40,40)})},e.prototype.createClusterIcon=function(t){var e=t.getAllChildMarkers().reduce(function(t,e){return t+e.options.origRow.rowcount},0);return this.createIcon(e)},e.prototype.createH3Indices=function(t){var e=this;this.clear(),t.forEach(function(t){if(t.rowcount<e.service.childThreshold||t.childrows.Row.length)t.childrows.Row.forEach(function(r){var i=new o.leaflet.Marker([r.lat,r.lng],{icon:o.Leaflet.BeautifyIcon({iconShape:"marker",icon:"fa-circle",textColor:"#ffffff",borderColor:"transparent",backgroundColor:"#376cea",props:{owner:e,row:t}}),origRow:t}).on("click",function(r){return e.clickHandler(r,t)}),n="";for(var s in r.payload)n+="<b>"+s+":</b>  "+r.payload[s]+"<br>";i.bindTooltip(n),e.add(i)});else{var r=new o.leaflet.Polygon(e.fixDateLine([t.center.lat,t.center.lon],t.boundary.Row.map(function(t){return[t.lat,t.lon]})),{color:"gray",fillColor:"lightgray",opacity:e.opacity(),fillOpacity:e.opacity(),origRow:t}).on("click",function(r){return e.clickHandler(r,t)});e.add(r);var i=new o.leaflet.Marker([t.center.lat,t.center.lon],{icon:e.createIcon(t.rowcount),origRow:t}).on("click",function(r){return e.clickHandler(r,t)});i.bindTooltip("Row Count:  "+t.rowcount),e.add(i)}})},e.prototype.updateHexagons=function(){this._palette=this._palette.switch(this.paletteID()),this.useClonedPalette()&&(this._palette=this._palette.cloneNotExists(this.paletteID()+"_"+this.id()));var t,e,r,i=(t=this.h3Resolution()-1)>15?15:t<0?0:t,o=function(t){return t.pad(.1)}(this.visibleBounds()),n=P(o.getWest()),s=D(o.getNorth()),a=P(o.getEast()),l=D(o.getSouth()),u=[[s,n],[s,a],[l,a],[l,n]],p=this;e=u,r=i,p.service.submit(u,i).then(function(t){u===e&&i===r&&p.createH3Indices(t)})},e}(C);W.prototype._class+=" visualizer_HexTest2",W.prototype.publish("baseUrl",null,"string"),t.VizRoxie=W,t.VizWU=m,Object.defineProperty(t,"__esModule",{value:!0})});