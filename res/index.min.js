define(["exports","@hpcc-js/common","@hpcc-js/composite","@hpcc-js/form","@hpcc-js/map","@hpcc-js/other","@hpcc-js/chart","@hpcc-js/comms","@hpcc-js/dgrid","@hpcc-js/layout","@hpcc-js/graph"],function(e,t,r,i,s,o,n,a,u,l,p){var c=function(e,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function h(e,t){function r(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var d=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t}(l.Grid);d.prototype._class+=" visualizer_VisualizerGrid",d.prototype.publish("maxRowCount",1e4,"number");var f=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._filter={},t._table=new u.Table,t}return h(t,e),t.prototype.update=function(t,r){e.prototype.update.call(this,t,r)},t.prototype.render=function(t){var r=this;if(0===this._renderCount){var i=this.data().length;this.data().forEach(function(e,t){var i=e[0],s=(new n.Column).columns(["Field ID","Row Count"]).data(e[2].map(function(e){return[e.value,e.rowcount]})).on("click",function(e,t,s){s?r._filter[i]=e["Field ID"]:delete r._filter[i],r.refreshFilter()});r.setContent(0,t,s,e[0]+" ("+e[1]+")")}),this.setContent(i?1:0,0,this._table,"",2,i),this.refreshFilter()}return e.prototype.render.apply(this,arguments)},t.prototype.refreshFilter=function(){var e=this;a.Result.attach({baseUrl:this.baseUrl()},this.logicalFile(),void 0).fetchRows(0,this.maxRowCount(),!1,this._filter).then(function(t){var r=[],i={},s=t.map(function(e,t){var s=[];return 0===t&&Object.keys(e).forEach(function(e,t){r.push(e),i[e]=t}),Object.keys(e).forEach(function(t){s[i[t]]=e[t]}),s});e._table.columns(r).data(s).render()})},t.prototype.click=function(e,t,r){},t}(d);f.prototype._class+=" visualizer_Dashboard",f.prototype.publish("baseUrl",null,"string"),f.prototype.publish("logicalFile",null,"string");var g=function(e){function t(t){var r=e.call(this)||this;return r._id="",r._columns=[],r._data=[],r._metaResult=t,r._id=r._metaResult.name(),r._columns=[],r._data=[],r}return h(t,e),t.prototype.mapData=function(e){var t=this.mappings();return t.length?e.map(function(e){for(var r={},i=0,s=t;i<s.length;i++){var o=s[i];r[o.key]=e[o.value.toLowerCase()]}return r}):e},t.prototype.refreshData=function(e,t){var r=this;void 0===e&&(e={}),void 0===t&&(t=-1);var i,s={},n=!1,a=0;(this.filteredBy().forEach(function(t){var r=e[t.source+"__hpcc_visualization"];r&&(++a,t.mappings.forEach(function(e){s[e.value.toLowerCase()]=r.row[e.key]||r.row[e.key.toLowerCase()]})),n=!0},this),!n||a>0)?i=o.createResult(this._metaResult.url(),this.dataSource(),this.resultName()).query({Start:0,Count:t},s).then(function(e){return o.flattenResult(e,r.mappings())}):i=Promise.resolve({columns:[],data:[]});return i},t}(t.PropertyExt);g.prototype._class+=" WUWudget",g.prototype.publish("widgetClassID",null,"string","ESP Url"),g.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),g.prototype.publish("dataSource",null,"string","Data Source"),g.prototype.publish("resultName",null,"string","Result Name"),g.prototype.publish("mappings",null,"object","Widget Mappings"),g.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),g.prototype.publish("properties",null,"object","Widget Properties");var y=function(e){function t(t){var r=e.call(this)||this;return r._id="",r._columns=[],r._data=[],r._metaResult=t,r._id=r._metaResult.name(),r._columns=[],r._data=[],r}return h(t,e),t.prototype.createWidget=function(){var e=(new(this.widgetClass())).id(this.id());return this.properties().forEach(function(t){"function"==typeof e[t.key]&&e[t.key](t.value)}),e},t.prototype.parseClassID=function(e){var t=e.split("_");return{pkg:"@hpcc-js/"+t[0],def:t[1]}},t.prototype.requireWidget=function(e){var t=this;return new Promise(function(r,i){var s=t.parseClassID(e);if("@hpcc-js/visualizer"===s.pkg)switch(s.def){case"Dashboard":r(f)}else require([s.pkg],function(e){r(e[s.def])})})},t.prototype.resolveWidget=function(){var e=this;return this.requireWidget(e.widgetClassID()).then(function(t){e.widgetClass(t)})},t.prototype.resolve=function(){var e=this;return this._metaResult.query().then(function(t){return t&&t.length?t[0].vertices?e.widgetClassID(t[0].classid).verticesMeta(new g(e._metaResult).widgetClassID(t[0].vertices[0].classid).dataSource(t[0].vertices[0].datasource||e._metaResult.wuid()).resultName(t[0].vertices[0].resultname).mappings(t[0].vertices[0].mappings).filteredBy(t[0].vertices[0].filteredby).properties(t[0].vertices[0].properties)).edgesMeta(new g(e._metaResult).widgetClassID(t[0].edges[0].classid).dataSource(t[0].edges[0].datasource||e._metaResult.wuid()).resultName(t[0].edges[0].resultname).mappings(t[0].edges[0].mappings).filteredBy(t[0].edges[0].filteredby).properties(t[0].edges[0].properties)).filteredBy(t[0].filteredby).properties(t[0].properties):(t[0].properties.push({key:"baseUrl",value:e._metaResult._protocol+"//"+e._metaResult._host+"/"}),e.widgetClassID(t[0].classid).widgetMeta(new g(e._metaResult).widgetClassID(t[0].classid).dataSource(t[0].datasource||e._metaResult.wuid()).resultName(t[0].resultname).mappings(t[0].mappings).filteredBy(t[0].filteredby).properties(t[0].properties)).filteredBy(t[0].filteredby).properties(t[0].properties)):console.log("Visualizer meta-data is empty."),e.resolveWidget().then(function(){return e})})},t.prototype.refreshData=function(e,t){var r=this;void 0===e&&(e={}),void 0===t&&(t=-1);var i=this.widget();return i instanceof p.Graph?Promise.all([this.verticesMeta().refreshData(e,t),this.edgesMeta().refreshData({},-1)]).then(function(e){return r.refreshGraph(i,e[0].data,r.verticesMeta().properties(),e[1].data,r.edgesMeta().properties())}):this.widgetMeta().refreshData(e,t).then(function(e){return r.refreshWidget(i,e)})},t.prototype.refreshWidget=function(e,t){e.columns(t.columns).data(t.data).lazyRender()},t.prototype.refreshGraph=function(e,t,r,i,s){var o={},n=t.map(function(e){var t=(new p.Vertex).text(e[1]);return e[2]?t.faChar(e[2]):t.icon_diameter(0),r.forEach(function(e){"function"==typeof t[e.key]&&t[e.key](e.value)}),o[e[0]]=t,t}),a=i.map(function(e){var t=o[e[0]],r=o[e[1]];if(t&&r){var i=(new p.Edge).sourceVertex(t).targetVertex(r).text(e[2]);return e[2]&&i.text(e[2]),s.forEach(function(e){"function"==typeof i[e.key]&&i[e.key](e.value)}),i}t?console.log("Invalid edge - no target vertex."):r?console.log("Invalid edge - no source vertex."):console.log("Invalid edge - no source or target verticies.")}).filter(function(e){return!!e});e.data({vertices:n,edges:a}).lazyRender()},t}(t.Widget);y.prototype._class+=" WUWudget",y.prototype.publish("widgetClassID",null,"string"),y.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),y.prototype.publish("widget",null,"object","Widget Instance"),y.prototype.publish("widgetMeta",null,"object"),y.prototype.publish("verticesMeta",null,"object"),y.prototype.publish("edgesMeta",null,"object"),y.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),y.prototype.publish("properties",null,"object","Widget Properties"),s.topoJsonFolder("https://unpkg.com/@hpcc-js/map@2.0.0/TopoJSON"),o.enableCache(!0);var _=function(){function e(e){this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={},this._espUrl=e,this._espWorkunit=o.createConnection(this._espUrl),this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={}}return e.prototype.resetPersist=function(){return this._espWorkunit.appData("HPCC-Visualizer","persist"," ")},e.prototype.submitPersist=function(){if(this.grid){var e=o.Persist.serialize(this.grid);this._espWorkunit.appData("HPCC-Visualizer","persist",e)}},e.prototype.fetchPersist=function(){return this._espWorkunit.appData("HPCC-Visualizer","persist").then(function(e){if(e){var t=JSON.parse(e);switch(t.__class){case"visualizer_Dashboard":return r.Persist.deserializeFromObject(new f,t);case"visualizer_VisualizerGrid":return r.Persist.deserializeFromObject(new d,t);default:return r.Persist.create(e)}}return Promise.resolve(null)}).catch(function(e){return Promise.resolve(null)})},e.prototype.fetchWUWidgets=function(){return this._espWorkunit.results().then(function(e){var r=[];return e.filter(function(e){return t.Utility.endsWith(e.name(),"__hpcc_visualization")}).forEach(function(e){var t=new y(e);r.push(t.resolve())}),Promise.all(r)})},e.prototype.createGrid=function(){var e=this;return Promise.all([this.fetchPersist(),this.fetchWUWidgets()]).then(function(t){e.grid=t[0],e._wuWidgets=[],e._wuWidgetMap={};var r=t[1];if(!e.grid){if(1===r.length&&r[0].widgetClass()===f)return e.grid=r[0].createWidget(),r[0].widget(e.grid),r[0].refreshData({},e.grid.maxRowCount()).then(function(){return e.grid});e.grid=new d}var i=Math.ceil(Math.sqrt(r.length)),s=Math.ceil(r.length/i),o=3*(i+1),n=3*(s+1);return e.grid.snappingColumns(o).snappingRows(n),r.forEach(function(t,r){var s=e.grid.getContent(t.id());if(!s){var o=0,n=0;for(s=t.createWidget();null!==e.grid.getCell(3*o,3*n);)++n>=i&&(n=0,++o);e.grid.setContent(3*o,3*n,s,null,3,3)}switch(s.classID()){case"graph_Graph":s.on("vertex_click",function(t,r,i){e.refreshFilters(this.id(),t,r,i)});break;default:s.on("click",function(t,r,i){e.refreshFilters(this.id(),t,r,i)})}s._wuMeta=t,t.widget(s),e._wuWidgets.push(t),e._wuWidgetMap[t.id()]=t}),e.grid})},e.prototype.refresh=function(){var e=this;this._wuWidgets.forEach(function(t){t.refreshData(e._wuDashSel,e.grid.maxRowCount())})},e.prototype.refreshFilters=function(e,t,r,i){var s=this;i?this._wuDashSel[e]={row:t,col:r}:delete this._wuDashSel[e],this._wuWidgets.forEach(function(t){t.filteredBy().forEach(function(r){e===r.source+"__hpcc_visualization"&&t.refreshData(s._wuDashSel,s.grid.maxRowCount())})})},e}(),v=function(e){function t(){return e.call(this)||this}return h(t,e),t.prototype.toggleProperties=function(){var e=r.Dermatology.prototype.toggleProperties.apply(this,arguments);return this._showProperties||this.wuDashboard.submitPersist(),e},t.prototype.reset=function(){var e=this;this.wuDashboard.resetPersist().then(function(t){o.cache({}),delete e._prevEspUrl,e.render(function(e){})})},t.prototype.enter=function(){r.Dermatology.prototype.enter.apply(this,arguments);var e=this;this._resetButton=(new i.Button).id(this.id()+"_reset").value("Reset").on("click",function(){e.reset()}),this._toolbar.widgets([this._resetButton,this._propsButton])},t.prototype.update=function(){if(r.Dermatology.prototype.update.apply(this,arguments),this._prevEspUrl!==this.espUrl()){this._prevEspUrl=this.espUrl(),this.espCache()&&o.cache(JSON.parse(this.espCache()));var e=this;this.wuDashboard=new _(this.espUrl()),this.wuDashboard.createGrid().then(function(t){e.widget(t).render(function(t){e.wuDashboard.refresh()})})}},t}(r.Dermatology);v.prototype._class+=" BundleDermatology",v.prototype.publish("espUrl",null,"string","ESP Url"),v.prototype.publish("espCache",null,"string","ESP Cache"),e.BundleDermatology=v,e.WUDashboard=_,Object.defineProperty(e,"__esModule",{value:!0})});